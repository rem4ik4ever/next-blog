{"ast":null,"code":"import { removeOldFile } from 'src/cms/blogs/utils';\nimport devonlyMiddleware from 'src/middlewares/devonly.middleware';\nimport utilities from '@rem-blog/utilities';\n\nconst getFileKeyFromUrl = url => {\n  try {\n    const key = url.split('/assets/')[1];\n    return `assets/${key}`;\n  } catch (err) {\n    return null;\n  }\n};\n\nconst handler = async (req, res) => {\n  try {\n    const {\n      allFiles\n    } = utilities.Files;\n    const {\n      s3DeleteFile\n    } = utilities.AWS_S3;\n    await devonlyMiddleware(req, res);\n\n    if (req.method === 'DELETE') {\n      const {\n        id\n      } = req.query;\n      const files = allFiles();\n      const file = files.find(fl => String(fl.id) === String(id));\n\n      if (!file) {\n        res.statusCode = 404;\n        res.end();\n      } else {\n        const key = getFileKeyFromUrl(file.url);\n        const deleted = await s3DeleteFile(key);\n\n        if (!deleted) {\n          res.statusCode = 400;\n          res.end('Failed to delete file');\n        } else {\n          removeOldFile(file.filename, 'assets');\n          res.statusCode = 200;\n          res.end('File was deleted');\n        }\n      }\n    }\n  } catch (_) {\n    res.statusCode = 404;\n    res.end();\n  }\n};\n\nexport default handler;","map":null,"metadata":{},"sourceType":"module"}